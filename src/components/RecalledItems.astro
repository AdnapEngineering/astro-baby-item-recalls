---
const today = new Date();
const sevenDaysAgo = new Date(today);
sevenDaysAgo.setDate(today.getDate() - 7);

const formatDate = (date: Date) => date.toISOString().split("T")[0];

const startDate = formatDate(sevenDaysAgo);
const endDate = formatDate(today);

const API_URL = `https://www.saferproducts.gov/RestWebServices/Recall?format=json&field_rc_date_value=${startDate}&field_rc_date_value_1=${endDate}&field_rc_recall_by_product_target_id=119`;

interface RecallProduct {
  Name?: string;
}

interface Organization {
  Name: string;
}

interface RecallItem {
  RecallID: string;
  Title: string;
  RecallDate: string;
  URL?: string;
  ConsumerContact?: string;
  Products?: RecallProduct[];
  Retailers?: Organization[];
}

interface RecallCardItem {
  id: string;
  name: string;
  reason: string;
  recallDate: string;
  link: string;
  consumerContact?: string;
  retailers?: string[];
}

let recalledItems: RecallCardItem[] = [];

try {
  const res = await fetch(API_URL);
  if (res.ok) {
    const data: RecallItem[] = await res.json();

    recalledItems = data.slice(0, 10).map((item): RecallCardItem => ({
      id: item.RecallID,
      name: item.Title,
      reason: item.Products?.[0]?.Name || "No details provided",
      recallDate: item.RecallDate,
      link: item.URL || "https://www.cpsc.gov/Recalls",
      consumerContact: item.ConsumerContact,
      retailers: item.Retailers?.map(r => r.Name) || [],
    }));
  } else {
    console.error("API error:", res.statusText);
  }
} catch (err) {
  console.error("Fetch failed:", err);
}
---
<div class="max-w-3xl mx-auto p-4 bg-primary/10 border border-primary rounded-lg">
  <h2 class="text-xl font-bold text-primary border-b border-primary/30 pb-2 mb-4">
    Recent Baby Product Recalls
  </h2>

  <p class="mb-6 text-base-content/80">
    Please check your items against this list for your child's safety.
  </p>

  <div class="grid gap-4">
    {recalledItems.map(item => (
      <div class="card border-l-4 border-primary bg-base-100 shadow-md" id={item.id}>
        <div class="card-body">
          <h3 class="card-title">{item.name}</h3>

          <p>
            <span class="font-semibold">Reason for Recall:</span> {item.reason}
          </p>
          <p>
            <span class="font-semibold">Recall Date:</span> {new Date(item.recallDate).toLocaleDateString()}
          </p>

          {item.consumerContact && (
            <div class="collapse collapse-arrow bg-base-200">
              <input type="checkbox" />
              <div class="collapse-title font-semibold">Contact Information</div>
              <div class="collapse-content text-sm">{item.consumerContact}</div>
            </div>
          )}

          {item.retailers?.length > 0 && (
            <div class="collapse collapse-arrow bg-base-200 mt-2">
              <input type="checkbox" />
              <div class="collapse-title font-semibold">Retailers</div>
              <div class="collapse-content text-sm">
                <ul class="list-disc list-inside">
                  {item.retailers.map(name => <li>{name}</li>)}
                </ul>
              </div>
            </div>
          )}

          <div class="card-actions justify-end mt-4">
            <a
              href={item.link}
              target="_blank"
              rel="noopener noreferrer"
              class="btn btn-sm btn-primary text-primary-content"
            >
              Official Notice â†’
            </a>
          </div>
        </div>
      </div>
    ))}
  </div>
</div>
